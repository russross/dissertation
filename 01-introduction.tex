\chapter{Introduction}

This dissertation presents the design and implementation of a distributed file system. The design is motivated by the requirements of a new environment that emerges at the intersection of three trends: the renaissance of machine virtualization as a tool for hardware management, the increasing use of commodity hardware and software for server applications, and the emergence of computation as a commodity service.

Providing computing services for hire is nothing new, but previous offerings have always been on a limited scale, restricted to a specific type of application, or tied to the tool stack of a single vendor. Web and email hosting services are commonplace, and many applications like tax preparation software and payroll management are available as hosted services. Numerous frameworks for hosted computing have been proposed \cite{amir,vahdat,tullmann} and commercially implemented \cite{amazon}, but these require using a specific distributed framework or middleware that introduces a ``semantic bottleneck'' between the application and the hosting environment \cite{roscoe00}. The only way to make hosted computing a commodity is to convince vendors and customers to agree on a common set of interfaces so that applications can be easily moved from one host to the next and an open marketplace can emerge.

Seeking universal agreement on a new application environment is a daunting task, but one that can be circumvented by using an existing platform that already enjoys wide acceptance: the PC. Machine virtualization technology makes it possible to emulate a standard PC with low overhead, while still controlling the resources clients have access to and giving them a secure, reliable environment. Using virtual machines as basic deployment units gives applications access to standard tools and operating systems, and lets them move more easily from a local testing environment to a remote host, or between competing vendors. The combination of flexibility, compatibility, and manageability makes virtual machines stand out as a commodity hosting container.

In this dissertation, I propose that a platform for a commodity computation service be built on clusters of commodity hardware, using virtual machines as the management unit. Designing for clusters introduces scale at the implementation level that platform providers can exploit to reduce costs, support a wider range of applications, and foster an ecosystem of intermediate service providers. Instead of managing a complete tool stack demanding a diverse range of expertise, vendors can specialize in hardware provision and management while still achieving the scale to make it worthwhile and leave room for service differentiation. More specialized services and middleware can exist as a value-added service from the same vendor, or third-party providers can layer their services above the virtualized hardware and sell their software and expertise to end users. In this way, vendors of hosted services can focus their efforts on their core expertise without having to build a widely-distributed network or branch out into hardware management as a prerequisite.

Numerous research and engineering challenges are posed by this environment, but this dissertation focuses on providing storage to hosted virtual machines. Unlike other cluster file systems that focus on parallel computation and other scientific workloads, the Envoy file system proposed here is optimized for the requirements of commodity computation. Managers must be able to migrate running services to balance load and make efficient use of hardware resources, so storage cannot be tied to a specific host. Most virtual machines require private boot images, but some also need to coordinate their efforts through shared storage, with flexible control over shared access. The storage system must offer efficient shared access to images with strong consistency guarantees, but it must also accomodate many private images per machine across thousands of machines.

Forcing clients to start from scratch with each deployment and upload an entire operating system image would be costly and slow, and hosting multiple file system images per machine adds a new factor to scaling requirements, particularly capacity scaling \cite{warfield}. Expanding the definition of the environment to include a base of commodity software as well as a commodity hardware interface offers a solution to both problems. A few well-known software distributions can be installed by the vendor and offered to clients as templates that they can customize according to their own requirements. By deliberately injecting redundancy into client images, the demands on storage can be reduced to a few template images plus the customizations and other data introduced by each client. Besides easing the storage demands and making inter-client caching more effective, this ties the cost of commodity computation to the degree of customization required. Clients using standard tools enjoy a lower deployment cost than those requiring extensive customization, encouraging standardization through economic pressures without imposing artificial limitations.

Storage systems are normally measured by their performance, but their suitability to the environment they serve is equally important. If clusters of untrusted virtual machines are to succeed as a commodity computation platform, they must be served by a storage system optimized for the expected workload and with adequate features to make management practical.

\section{Contributions}

The thesis of this disseration is that clusters hosting virtual machines provide a viable platform for commodity computation, and a file system optimized for that environment can support the commodity computation model by providing useful management features and scaling to accomodate arbitrary numbers of file system images under expected workloads.

The first contribution of this work is a definition of the requirements of a flexible commodity computation environment. Commodities are homogeneous enough to make suppliers interchangable, and have a large enough market that the cost to clients is directly related to the marginal costs of the product or service as driven by economic forces. I argue specificaly for clusters of commodity hardware as the basis of a computation platform, with computation in a virtual machine as the product offered to customers.

The second contribution of this dissertation is the design and prototype implementation of a file system designed for the outlined environment. It builds on previous work on cluster storage systems, but addresses the management needs and scaling characteristics of a platform supporting many independent clients. It also exploits its environment to use the cheap storage available on commodity machines, reduce complexity by integrating with the virtual machine structure, and reduce capacity requirements by explicitly acknowledging the redundancy resulting from a template-based deployment model.

\section{Outline}

The remainder of this disseration is structured as follows:

\charef{cha:background} discusses the relevant background, including the state of commodity computation and the developments in machine virtualization that underpin this work. Special attention is given to the extensive body of work on storage systems with a focus on how storage systems are shaped by their intended environments, and how they relate to the new environment proposed here.

In \charef{cha:motivation} I define the problem of flexible commodity computation, and argue for virtual machines hosted by clusters of commodity hardware as a suitable platform for a computation economy. The first part of the argument is that virtual machines decouple hardware management from software management, encouraging transparent competition and specialization that is not tied to a particular application domain. The second point is that clusters take advantage of economies of scale and allow unrelated clients to share hosting, where careful management can balance the demands of diverse users and make efficient use of resources. The chapter concludes with a discussion of the role of the storage system in this environment.

\charef{cha:design} presents Envoy, a file system for clusters of virtual machines. Like many cluster file systems it builds on a seperate object storage layer, but this work does not contribute anything new to object storage so the specifics of this layer are omitted. Envoy partitions management of the global namespace along hierarchical lines, assigning control of a \emph{territory} to the machine that uses it most, and territory boundaries are dynamically updated in response to runtime conditions. Objects are cached and served by the machine that controls the associated territory, eliminating distributed cache coherency protocols and permitting cache sharing between clients.

The prototype implementation of Envoy is described in \charef{cha:implementation} and evaluated in \charef{cha:evaluation}. While some features are unfinished, the basic functionality of Envoy is fully implemented, with file systems exported to clients using a Linux implementation of the 9p protocol from the Plan~9 operation system. The evaluation tests the performance and scalability of the prototype, validating the overall design and  suggesting possible improvements in specific areas.

Finally, \charef{cha:conclusion} concludes and discusses directions for future investigation.